

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Customising the Generated API &mdash; pyramid_jsonapi 2.2.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Metadata Modules" href="metadata.html" />
    <link rel="prev" title="Consuming the API from the Client End" href="client.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> pyramid_jsonapi
          

          
          </a>

          
            
            
              <div class="version">
                2.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="welcome.html">The pyramid-jsonapi project</a></li>
<li class="toctree-l1"><a class="reference internal" href="welcome.html#quick-start">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-creation.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Consuming the API from the Client End</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customising the Generated API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-class-options">Model Class Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-column-options">Model Column Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-relationship-options">Model Relationship Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="#selectively-passing-models-for-api-generation">Selectively Passing Models for API Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#url-paths">URL Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modifying-endpoints">Modifying Endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="#search-filter-operators">Search (Filter) Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stages-and-the-workflow">Stages and the Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-loop-workflow">The Loop Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#authorisation-at-the-object-level">Authorisation at the Object Level</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-happens-with-authorisation-failures">What Happens With Authorisation Failures</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Metadata Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developing pyramid-jsonapi</a></li>
<li class="toctree-l1"><a class="reference internal" href="apidoc/pyramid_jsonapi.html">pyramid_jsonapi package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pyramid_jsonapi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Customising the Generated API</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/customisation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="customising-the-generated-api">
<span id="customisation"></span><h1>Customising the Generated API<a class="headerlink" href="#customising-the-generated-api" title="Permalink to this headline">¶</a></h1>
<div class="section" id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h2>
<p>Configuration options are managed by <code class="xref py py-mod docutils literal notranslate"><span class="pre">pyramid_settings_wrapper.Settings</span></code>.
This provides default values as class attributes.</p>
<p><strong>Configuration Options</strong></p>
<p>These options can be overridden in the pyramid app ini-file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allow client to specify resource ids.</span>
<span class="n">allow_client_ids</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># API version for prefixing endpoints and metadata generation.</span>
<span class="n">api_version</span> <span class="o">=</span>

<span class="c1"># Whether or not to add debugging endpoints.</span>
<span class="n">debug_endpoints</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Whether or not to add debug information to the meta key in returned JSON.</span>
<span class="n">debug_meta</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Module responsible for populating test data.</span>
<span class="n">debug_test_data_module</span> <span class="o">=</span> <span class="n">test_data</span>

<span class="c1"># Whether or not to add a stack traceback to errors.</span>
<span class="n">debug_traceback</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Expose foreign key fields in JSON.</span>
<span class="n">expose_foreign_keys</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># True = return information in meta about authz failures; False = pretend items don&#39;t exist</span>
<span class="n">inform_of_get_authz_failures</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Should /metadata endpoint be enabled?</span>
<span class="n">metadata_endpoints</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Modules to load to provide metadata endpoints (defaults are modules provided in the metadata package).</span>
<span class="n">metadata_modules</span> <span class="o">=</span> <span class="n">JSONSchema</span> <span class="n">OpenAPI</span>

<span class="c1"># File containing OpenAPI data (YAML or JSON)</span>
<span class="n">openapi_file</span> <span class="o">=</span>

<span class="c1"># Default pagination limit for collections.</span>
<span class="n">paging_default_limit</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Default limit on the number of items returned for collections.</span>
<span class="n">paging_max_limit</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Prefix for pyramid route names for view_classes.</span>
<span class="n">route_name_prefix</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span>

<span class="c1"># Separator for pyramid route names.</span>
<span class="n">route_name_sep</span> <span class="o">=</span> <span class="p">:</span>

<span class="c1"># Prefix for api endpoints (if metadata_endpoints is enabled).</span>
<span class="n">route_pattern_api_prefix</span> <span class="o">=</span> <span class="n">api</span>

<span class="c1"># Prefix for metadata endpoints (if metadata_endpoints is enabled).</span>
<span class="n">route_pattern_metadata_prefix</span> <span class="o">=</span> <span class="n">metadata</span>

<span class="c1"># &quot;Parent&quot; prefix for all endpoints</span>
<span class="n">route_pattern_prefix</span> <span class="o">=</span>

<span class="c1"># Separator for pyramid route patterns.</span>
<span class="n">route_pattern_sep</span> <span class="o">=</span> <span class="o">/</span>

<span class="c1"># File containing jsonschema JSON for validation.</span>
<span class="n">schema_file</span> <span class="o">=</span>

<span class="c1"># jsonschema schema validation enabled?</span>
<span class="n">schema_validation</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Module implementing the collection_get workflow.</span>
<span class="n">workflow_collection_get</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">collection_get</span>

<span class="c1"># Module implementing the collection_post workflow.</span>
<span class="n">workflow_collection_post</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">collection_post</span>

<span class="c1"># Module implementing the item_delete workflow.</span>
<span class="n">workflow_item_delete</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">item_delete</span>

<span class="c1"># Module implementing the item_get workflow.</span>
<span class="n">workflow_item_get</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">item_get</span>

<span class="c1"># Module implementing the item_patch workflow.</span>
<span class="n">workflow_item_patch</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">item_patch</span>

<span class="c1"># Module implementing the related_get workflow.</span>
<span class="n">workflow_related_get</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">related_get</span>

<span class="c1"># Module implementing the relationships_delete workflow.</span>
<span class="n">workflow_relationships_delete</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">relationships_delete</span>

<span class="c1"># Module implementing the relationships_get workflow.</span>
<span class="n">workflow_relationships_get</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">relationships_get</span>

<span class="c1"># Module implementing the relationships_patch workflow.</span>
<span class="n">workflow_relationships_patch</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">relationships_patch</span>

<span class="c1"># Module implementing the relationships_post workflow.</span>
<span class="n">workflow_relationships_post</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">relationships_post</span>
</pre></div>
</div>
</div>
<div class="section" id="model-class-options">
<h2>Model Class Options<a class="headerlink" href="#model-class-options" title="Permalink to this headline">¶</a></h2>
<p>The behaviour of classes (and, by extension, collections) is controlled via a special
class attribute, <code class="docutils literal notranslate"><span class="pre">__pyramid_jsonapi__</span></code>. The value of this attribute should be
a dictionary with each key representing an option name and each value
representing the option value. For example, the following will create a
<code class="docutils literal notranslate"><span class="pre">Person</span></code> class with a table name <code class="docutils literal notranslate"><span class="pre">people</span></code> in the database but a collection
name <code class="docutils literal notranslate"><span class="pre">humans</span></code> in the resulting API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;people&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">__pyramid_jsonapi__</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;collection_name&#39;</span><span class="p">:</span> <span class="s1">&#39;humans&#39;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>The available options are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 14%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>collection_name</p></td>
<td><p>string</p></td>
<td><p>Name of collection in the API.</p></td>
</tr>
<tr class="row-odd"><td><p>id_col_name</p></td>
<td><p>string</p></td>
<td><p>Used internally to track id column - do not use.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="model-column-options">
<h2>Model Column Options<a class="headerlink" href="#model-column-options" title="Permalink to this headline">¶</a></h2>
<p>Some behaviours can be controlled on a column by column basis. SQLAlchemy uses
the special column attribute <code class="docutils literal notranslate"><span class="pre">info</span></code> to carry information (as a dictionary)
from third party modules (like pyramid_jsonapi). The pyramid_jsonapi module
expects column options as a dictionary stored in the <code class="docutils literal notranslate"><span class="pre">pyramid_jsonapi</span></code> key of
the <code class="docutils literal notranslate"><span class="pre">info</span></code> dictionary. For example, to make a column called
<code class="docutils literal notranslate"><span class="pre">invisible_column</span></code> invisible to the API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;people&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">invisible_column</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">invisible_column</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pyramid_jsonapi&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;visible&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
</pre></div>
</div>
<p>Available column options:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 14%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>visible</p></td>
<td><p>Boolean</p></td>
<td><p>Whether or not to display this column in the API.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="model-relationship-options">
<h2>Model Relationship Options<a class="headerlink" href="#model-relationship-options" title="Permalink to this headline">¶</a></h2>
<p>The same <code class="docutils literal notranslate"><span class="pre">info</span></code> attribute used to specify column options above can be used to
specify relationship options. For example, to make a relationship called
<code class="docutils literal notranslate"><span class="pre">invisible_comments</span></code> invisible to the API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
  <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;people&#39;</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">invisible_comments</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">)</span>
  <span class="n">invisible_comments</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pyramid_jsonapi&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;visible&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
</pre></div>
</div>
<p>Available relationship options:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 14%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Value Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>visible</p></td>
<td><p>Boolean</p></td>
<td><p>Whether to display this relationship in the API.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="selectively-passing-models-for-api-generation">
<h2>Selectively Passing Models for API Generation<a class="headerlink" href="#selectively-passing-models-for-api-generation" title="Permalink to this headline">¶</a></h2>
<p>Your database may have some tables which you do not wish to expose as collections in the generated API. You can be selective by:</p>
<ul class="simple">
<li><p>writing a models module with only the model classes you wish to expose; or</p></li>
<li><p>passing an iterable of only the model classes you wish to expose to
<a class="reference internal" href="apidoc/pyramid_jsonapi.html#pyramid_jsonapi.PyramidJSONAPI" title="pyramid_jsonapi.PyramidJSONAPI"><code class="xref py py-func docutils literal notranslate"><span class="pre">pyramid_jsonapi.PyramidJSONAPI()</span></code></a>.</p></li>
</ul>
</div>
<div class="section" id="url-paths">
<h2>URL Paths<a class="headerlink" href="#url-paths" title="Permalink to this headline">¶</a></h2>
<p>There are a number of <cite>prefix</cite> configuration options that can be used to customise the URL path used in the generated API.
These are useful for mixing the API with other pages, adding API versioning etc.</p>
<p>The path is constructed as follows - omitting any variables which are unset.
The separator between fields is <cite>route_pattern_sep</cite> - shown here as the default ‘/’.
<cite>type</cite> is one of either <cite>api</cite> or <cite>metadata</cite>.</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">/route_pattern_prefix/api_version/route_pattern_&lt;type&gt;_prefix/endpoint</span>
<span class="pre">`</span></code></p>
<p>These options and their defaults are documented above in <cite>Configuration Options</cite>.</p>
</div>
<div class="section" id="modifying-endpoints">
<h2>Modifying Endpoints<a class="headerlink" href="#modifying-endpoints" title="Permalink to this headline">¶</a></h2>
<p>Endpoints are created automatically from a dictionary: <code class="xref py py-data docutils literal notranslate"><span class="pre">api_object.endpoint_data.endpoints</span></code>.</p>
<p>This takes the following format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s1">&#39;query_parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">],</span>
    <span class="s1">&#39;sort&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="s1">&#39;responses&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">HTTPOK</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A server MUST respond to a successful request to fetch an individual resource or resource collection with a 200 OK response.&#39;</span><span class="p">]}},</span>
  <span class="s1">&#39;endpoints&#39;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">&#39;request_schema&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
      <span class="s1">&#39;route_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;{&#39;</span><span class="n">fields</span><span class="s1">&#39;: [&#39;</span><span class="nb">id</span><span class="s1">&#39;], &#39;</span><span class="n">pattern</span><span class="s1">&#39;: &#39;</span><span class="p">{{{}}}</span><span class="s1">&#39;}&#39;</span><span class="p">,</span>
      <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
          <span class="s1">&#39;responses&#39;&#39;: { HTTPOk: {&#39;</span><span class="n">reason</span><span class="s1">&#39;: [&#39;</span><span class="n">A</span> <span class="n">server</span> <span class="n">MUST</span> <span class="k">return</span> <span class="n">a</span> <span class="mi">200</span> <span class="n">OK</span> <span class="n">status</span> <span class="n">code</span> <span class="k">if</span> <span class="n">a</span> <span class="n">deletion</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">successful</span><span class="s1">&#39;]}},</span>
        <span class="p">},</span>
        <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;PATCH&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="s1">&#39;patch&#39;</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="o">...</span> <span class="c1"># other endpoints omitted</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">endpoints</span></code> and <code class="docutils literal notranslate"><span class="pre">methods</span></code> are the parts you are most likely to want to modify.</p>
<ul class="simple">
<li><p>There are 4 <code class="docutils literal notranslate"><span class="pre">endpoints</span></code> defined: <code class="docutils literal notranslate"><span class="pre">collection</span></code>, <code class="docutils literal notranslate"><span class="pre">item</span></code>, <code class="docutils literal notranslate"><span class="pre">relationships</span></code> and <code class="docutils literal notranslate"><span class="pre">related</span></code>.</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">endpoint</span></code> may have <code class="docutils literal notranslate"><span class="pre">route_pattern</span></code> defined. This is a list of fields, and the format string used to join them. (<code class="docutils literal notranslate"><span class="pre">{sep}</span></code> will be replaced with <code class="docutils literal notranslate"><span class="pre">route_name_sep</span></code>)</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">endpoint</span></code> may have 0 or more <code class="docutils literal notranslate"><span class="pre">http_methods</span></code> defined. (<code class="docutils literal notranslate"><span class="pre">GET</span></code>, <code class="docutils literal notranslate"><span class="pre">POST</span></code>, etc).</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">endpoint</span></code> may have <code class="docutils literal notranslate"><span class="pre">responses</span></code> defined. This is a dictionary of <code class="docutils literal notranslate"><span class="pre">pyramid.httpexceptions</span></code> keys, the value is a dict with <code class="docutils literal notranslate"><span class="pre">reason</span></code>
containing list of reasons for returning this response.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">request_schema</span></code> defines whether or not this endpoint expects a request body (for jsonschema generation/validation).</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">method</span></code> must have <code class="docutils literal notranslate"><span class="pre">function</span></code> defined. This is the name (string) of the view function to call for this endpoint.</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">method</span></code> may have a <code class="docutils literal notranslate"><span class="pre">renderer</span></code> defined (if omitted, this defaults to <code class="docutils literal notranslate"><span class="pre">'json'</span></code>).</p></li>
</ul>
<p>Additionally, the following keys are provided (though are less likely to be modified).</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">query_parameters</span></code> defines the http query parameters that endpoints expect.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">responses</span></code> defines the various http responses (keyed by <code class="docutils literal notranslate"><span class="pre">pyramid.httpexceptions</span></code> objects )
that may be returned, and the reason(s) why.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">responses</span></code> are used in the code to validate responses, and provide schema information.</p></li>
<li><p>responses can be defined at a ‘global’, endpoint, or method level, and will be merged together as appropriate.</p></li>
<li><p>you may wish to modify <code class="docutils literal notranslate"><span class="pre">responses</span></code> if your app wishes to return statuses outside of the schema,
to prevent them being flagged as errors.</p></li>
</ul>
<p>For example, to extend this structure to handle the <code class="docutils literal notranslate"><span class="pre">OPTIONS</span></code> <code class="docutils literal notranslate"><span class="pre">http_method</span></code> for all endpoints (e.g. for <a class="reference external" href="https://enable-cors.org">CORS</a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Create a view class method.</span>
<span class="k">def</span> <span class="nf">options_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># Instantiate the class</span>
<span class="n">pj</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">PyramidJSONAPI</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">dbsession</span><span class="p">)</span>

<span class="c1"># Update all endpoints to handle OPTIONS http_method requests</span>
<span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">pj</span><span class="o">.</span><span class="n">EndpointData</span><span class="o">.</span><span class="n">endpoints</span><span class="p">:</span>
    <span class="n">pj</span><span class="o">.</span><span class="n">EndpointData</span><span class="o">.</span><span class="n">endpoints</span><span class="p">[</span><span class="n">endpoint</span><span class="p">][</span><span class="s1">&#39;http_methods&#39;</span><span class="p">][</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="s1">&#39;options_view&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;renderer&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>

<span class="c1"># Create the view_classes</span>
<span class="n">pj</span><span class="o">.</span><span class="n">create_jsonapi</span><span class="p">()</span>

<span class="c1"># Bind the custom options method (defined above) to each view_class</span>
<span class="k">for</span> <span class="n">vc</span> <span class="ow">in</span> <span class="n">pj</span><span class="o">.</span><span class="n">view_classes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">vc</span><span class="o">.</span><span class="n">options_view</span> <span class="o">=</span> <span class="n">options_view</span>
</pre></div>
</div>
</div>
<div class="section" id="search-filter-operators">
<span id="id1"></span><h2>Search (Filter) Operators<a class="headerlink" href="#search-filter-operators" title="Permalink to this headline">¶</a></h2>
<p>Search filters are on collection get operations are specified with URL paramaters of the form filter[attribute:op]=value. A number of search/filter operators are supported out of the box. The list currently includes the following for all column types:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">eq</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ne</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">startswith</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">endswith</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contains</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">le</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ge</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">like</span></code> or <code class="docutils literal notranslate"><span class="pre">ilike</span></code>. Note that both of these use ‘*’ in place of ‘%’ to
avoid much URL escaping.</p></li>
</ul>
<p>plus these for JSONB columns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">contains</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contained_by</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">has_all</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">has_any</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">has_key</span></code></p></li>
</ul>
<p>You can add support for new filters using the <code class="xref py py-attr docutils literal notranslate"><span class="pre">PyramidJSONAPI.filter_registry</span></code> (which is an instance of <code class="xref py py-class docutils literal notranslate"><span class="pre">FilterRegistry</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj_api</span><span class="o">.</span><span class="n">filter_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;my_comparator&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above would register the sqlalchemy column comparator <code class="docutils literal notranslate"><span class="pre">my_comparator</span></code> (which should exist as a valid sqlalchemy comparator function) as valid for all column types and also create a URL filter op called <code class="docutils literal notranslate"><span class="pre">my_comparator</span></code>. Any instances of <code class="docutils literal notranslate"><span class="pre">__</span></code> (double underscore) are stripped from the comparator name to create the filter name, so if we had called the comparator <code class="docutils literal notranslate"><span class="pre">__my_comparator__</span></code> it would still become the filter operator <code class="docutils literal notranslate"><span class="pre">my_comparator</span></code>. For example, the sqlalachemy comparator <code class="docutils literal notranslate"><span class="pre">__eq__</span></code> is registered with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj_api</span><span class="o">.</span><span class="n">filter_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;__eq__&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>But has a filter name of <code class="docutils literal notranslate"><span class="pre">eq</span></code>.</p>
<p>You can override the autogenerated name by providing one as an argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj_api</span><span class="o">.</span><span class="n">filter_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;my_comparator&#39;</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s1">&#39;my_filter&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The comparator/filter combination is valid for all column types by default, which is the same as specifying:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj_api</span><span class="o">.</span><span class="n">filter_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;my_comparator&#39;</span><span class="p">,</span> <span class="n">column_type</span><span class="o">=</span><span class="s1">&#39;__ALL__&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Comparators can be registered as valid for individual column types by passing a column type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">JSONB</span>
<span class="n">pj_api</span><span class="o">.</span><span class="n">filter_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;my_comparator&#39;</span><span class="p">,</span> <span class="n">column_type</span><span class="o">=</span><span class="n">JSONB</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s also possible to specify a value transformation function to change the paramter value before it is passed to the comparator. For example the <code class="docutils literal notranslate"><span class="pre">like</span></code> filter swaps all ‘*’ characters for ‘%’ before calling the associated <code class="docutils literal notranslate"><span class="pre">like</span></code> comparator. It is registered like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj_api</span><span class="o">.</span><span class="n">filter_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
  <span class="s1">&#39;like&#39;</span><span class="p">,</span>
  <span class="n">value_transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="stages-and-the-workflow">
<h2>Stages and the Workflow<a class="headerlink" href="#stages-and-the-workflow" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">pyramid_jsonapi</span></code> services requests in stages. These stages are sequences of
functions implemented as a <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.deque" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">collections.deque</span></code></a> for each stage on each
method of each view class. It is possible to add (or remove) functions to those
deques directly but it is recommended that you use the following utility
function instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">view_class</span><span class="o">.</span><span class="n">add_stage_handler</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;collection_get&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;alter_document&#39;</span><span class="p">],</span> <span class="n">hfunc</span><span class="p">,</span>
    <span class="n">add_after</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">,</span>  <span class="c1"># &#39;end&#39; is the default</span>
    <span class="n">add_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># False is the default</span>
<span class="p">)</span>
</pre></div>
</div>
<p>will append <code class="docutils literal notranslate"><span class="pre">hfunc</span></code> to the deque for the <code class="docutils literal notranslate"><span class="pre">alter_document</span></code> stage of
<code class="docutils literal notranslate"><span class="pre">view_class</span></code>’s methods <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">collection_get</span></code>. <code class="docutils literal notranslate"><span class="pre">add_after</span></code> can be
<code class="docutils literal notranslate"><span class="pre">'end'</span></code> to append to the deque, <code class="docutils literal notranslate"><span class="pre">'start'</span></code> to appendleft, or an existing
handler in the deque to insert after it. <code class="docutils literal notranslate"><span class="pre">add_existing</span></code> is a boolean
determining whether the handler should be added to the deque even if it exists
there already.</p>
<p>To register a handler for all of the view methods involved in servicing a
particular http method, use <code class="docutils literal notranslate"><span class="pre">pj.endpoint_data.http_to_view_methods</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">view_class</span><span class="o">.</span><span class="n">add_stage_handler</span><span class="p">(</span>
    <span class="n">api_instance</span><span class="o">.</span><span class="n">endpoint_data</span><span class="o">.</span><span class="n">http_to_view_methods</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;alter_request&#39;</span><span class="p">],</span>
    <span class="n">hfunc</span><span class="p">,</span>
    <span class="n">add_after</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">,</span>  <span class="c1"># &#39;end&#39; is the default</span>
    <span class="n">add_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># False is the default</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The above would append <code class="docutils literal notranslate"><span class="pre">hfunc</span></code> to the stage <code class="docutils literal notranslate"><span class="pre">alter_request</span></code> for all of the
view methods associated with the http method <code class="docutils literal notranslate"><span class="pre">post</span></code> (<code class="docutils literal notranslate"><span class="pre">collection_post</span></code>,
<code class="docutils literal notranslate"><span class="pre">relationships_post</span></code>).</p>
<p>If you do want to get directly at a stage deque, you can get it with something
like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ar_stage</span> <span class="o">=</span> <span class="n">pj</span><span class="o">.</span><span class="n">view_classes</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Person</span><span class="p">]</span><span class="o">.</span><span class="n">collection_post</span><span class="o">.</span><span class="n">stages</span><span class="p">[</span><span class="s1">&#39;alter_request&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The handler functions in each stage deque will be called in
order at the appropriate point and should have the following signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handler_function</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">view_instance</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">view_method</span><span class="p">):</span>
  <span class="c1"># some function definition...</span>
  <span class="k">return</span> <span class="n">same_type_of_thing_as_argument</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">argument</span></code> in the <code class="docutils literal notranslate"><span class="pre">alter_request</span></code> stage would be a request, for example,
while in <code class="docutils literal notranslate"><span class="pre">alter_document</span></code> it would be a document object. <code class="docutils literal notranslate"><span class="pre">argument</span></code> and
<code class="docutils literal notranslate"><span class="pre">view_instance</span></code> are passed positionally while <code class="docutils literal notranslate"><span class="pre">stage</span></code> and <code class="docutils literal notranslate"><span class="pre">view_method</span></code>
are keyword arguments. Handlers in a stage deque should work as a pipeline so
it is important that you return the (potentially altered or replaced
<code class="docutils literal notranslate"><span class="pre">argument</span></code>)</p>
<p>For example, let’s say you would like to alter all posts to the people
collection so that a created_on_server attribute is populated automatically.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>

<span class="k">def</span> <span class="nf">sh_created_on_server</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">obj_data</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">json_body</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
  <span class="n">obj_data</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">][</span><span class="s1">&#39;created_on_server&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
  <span class="n">req</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">obj_data</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">req</span>

<span class="n">pj</span><span class="o">.</span><span class="n">view_classes</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Person</span><span class="p">]</span><span class="o">.</span><span class="n">add_stage_handler</span><span class="p">(</span>
  <span class="p">[</span><span class="s1">&#39;collection_post&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;alter_request&#39;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The stages are run in the following order:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alter_request</span></code>. Functions in this stage alter the request. For example
possibly editing any POST or PATCH such that it contains a server defined
calculated attribute.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_request</span></code>. Functions in this stage validate the request. For
example, ensuring that the correct headers are set and that any json validates
against the schema.</p></li>
<li><p>Any stages defined by a <code class="docutils literal notranslate"><span class="pre">workflow</span></code> function from a loadable workflow module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alter_document</span></code>. Functions in this stage alter the <code class="docutils literal notranslate"><span class="pre">document</span></code>, which is
to say the dictionary which will be JSON serialised and sent back in the
response.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_response</span></code>.</p></li>
</ul>
</div>
<div class="section" id="the-loop-workflow">
<h2>The Loop Workflow<a class="headerlink" href="#the-loop-workflow" title="Permalink to this headline">¶</a></h2>
<p>The default workflow is the <code class="docutils literal notranslate"><span class="pre">loop</span></code> workflow. It defines the following stages:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alter_query</span></code>. Alter the <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.query.Query</span></code> which will be
executed (using <code class="docutils literal notranslate"><span class="pre">.all()</span></code> or <code class="docutils literal notranslate"><span class="pre">.one()</span></code>) to fetch the primary result(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alter_related_query</span></code>. Alter the <code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.orm.query.Query</span></code> which
will be executed to fetch related result(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alter_result</span></code>. Alter a <code class="xref py py-class docutils literal notranslate"><span class="pre">workflow.ResultObject</span></code> object containing
a database result (a sqlalchemy orm object) from a query of the requested
collection. This might also involve rejecting the whole object (for example,
for authorisation purposes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">before_write_item</span></code>. Alter a sqlalchemy orm item before it is written
(flushed) to the database.</p></li>
</ul>
</div>
<div class="section" id="authorisation-at-the-object-level">
<h2>Authorisation at the Object Level<a class="headerlink" href="#authorisation-at-the-object-level" title="Permalink to this headline">¶</a></h2>
<p>Authorisation of access a the object level can quite complicated in typical
JSONAPI apis. The complexity arises from the connecting nature of relationships.
Every operation on an object with relationships implies other operations on any
related objects. The simplest example is <code class="docutils literal notranslate"><span class="pre">GET</span></code>: <code class="docutils literal notranslate"><span class="pre">get</span></code> permission is required
on any object directly fetched and <em>also</em> on any related object fetched. More
complicated is any write based operation. For example, to update the owner of a
blog, you need <code class="docutils literal notranslate"><span class="pre">patch</span></code> permission on <code class="docutils literal notranslate"><span class="pre">blog_x.owner</span></code>, <code class="docutils literal notranslate"><span class="pre">post</span></code> permission on
<code class="docutils literal notranslate"><span class="pre">new_owner.blogs</span></code> (to add <code class="docutils literal notranslate"><span class="pre">blog_x</span></code> to the reverse relationship) and
<code class="docutils literal notranslate"><span class="pre">delete</span></code> permission on <code class="docutils literal notranslate"><span class="pre">old_owner.blogs</span></code> (to remove <code class="docutils literal notranslate"><span class="pre">blog_x</span></code> from the
reverse relationship).</p>
<p>There are stage handlers available for stages which handle most of the logic of
authorisation. At the moment these are implemented for <code class="docutils literal notranslate"><span class="pre">alter_result</span></code> for read
operations and <code class="docutils literal notranslate"><span class="pre">alter_request</span></code> for write operations. Other stages might be
supported in the future.</p>
<p>The remaining logic is provided by permission filters which you
provide. The job of a permission filter is to decide, for an individual object,
whether the specified operation is allowed on that object or not. The permission
handler built in to pyramid_jsonapi will call the permission filters at the
appropriate times (including for related objects) and then stitch the answers
back together into a coherent, authorised whole.</p>
<p>The default permission filters allow everything, which is the same as not having
any permission handlers at all. Permission filters should be registered with
<code class="xref py py-func docutils literal notranslate"><span class="pre">CollectionView.register_permission_filter()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid_jsonapi.permissions</span> <span class="kn">import</span> <span class="n">Targets</span>

<span class="n">view_class</span><span class="o">.</span><span class="n">register_permission_filter</span><span class="p">(</span>
  <span class="n">permissions</span><span class="p">,</span>
  <span class="n">stages</span><span class="p">,</span>
  <span class="n">pfunc</span><span class="p">,</span>
  <span class="n">target_types</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">Targets</span><span class="p">)</span> <span class="c1"># the default is all target types.</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">permissions</span></code> is an iterable of permissions (as strings) that this filter will
handle. Permissions are equivalent to http verbs (lowercased) - ‘get’, ‘post’,
‘patch’, ‘delete’. You can also use any ‘permission set’ defined in
<code class="docutils literal notranslate"><span class="pre">pj.endpoint_data.endpoints['http_method_sets']</span></code>. At time of writing these are
‘read’ (equivalent to ‘get’), ‘write’ (‘post’, ‘patch’ and ‘delete’), and ‘all’.</p>
<p><code class="docutils literal notranslate"><span class="pre">stages</span></code> is an iterable of stage names.</p>
<p><code class="docutils literal notranslate"><span class="pre">pfunc</span></code> is the function to handle permission requests.</p>
<p><code class="docutils literal notranslate"><span class="pre">target_types</span></code> is an iterable of target types that this filter will handle.
Target types are a hint to permission filters specifying the type of target
being authorised in the current call. They are one of the
<code class="docutils literal notranslate"><span class="pre">pyramid_jsonapi.permissions.Targets</span></code> enumeration, which at time of writing
includes <code class="docutils literal notranslate"><span class="pre">Targets.collection</span></code> for collection based operations where an id
might not be included, <code class="docutils literal notranslate"><span class="pre">Targets.item</span></code> for operations directly on an item
and its attributes, and <code class="docutils literal notranslate"><span class="pre">Targets.relationship</span></code> for operations on
relationships.</p>
<p>Permission filters will be called from within the code like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">your_filter</span><span class="p">(</span>
  <span class="n">object_rep</span><span class="p">,</span>
  <span class="n">view</span><span class="o">=</span><span class="n">view_instance</span><span class="p">,</span>
  <span class="n">stage</span><span class="o">=</span><span class="n">stage_name</span><span class="p">,</span>
  <span class="n">permission</span><span class="o">=</span><span class="n">permission_sought</span><span class="p">,</span>
  <span class="n">target</span><span class="o">=</span><span class="n">PermissionTarget_object</span><span class="p">,</span>
  <span class="n">mask</span><span class="o">=</span><span class="n">Permission_object</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">object_rep</span></code> is some representation of the object to be authorised. Different
stages imply different representations. For example the <code class="docutils literal notranslate"><span class="pre">alter_request</span></code> stage
will pass a dictionary representing an item from <code class="docutils literal notranslate"><span class="pre">data</span></code> from the JSON
contained in a pyramid request while the <code class="docutils literal notranslate"><span class="pre">alter_result</span></code> stage from the loop
workflow will pass a <code class="xref py py-class docutils literal notranslate"><span class="pre">workflow.ResultObject</span></code>, which is a wrapper around a
sqlAlchemy ORM object (which you can get to as <code class="docutils literal notranslate"><span class="pre">object_rep.object</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">view</span></code> is the current view instance.</p>
<p><code class="docutils literal notranslate"><span class="pre">stage</span></code> is the name of the current stage.</p>
<p><code class="docutils literal notranslate"><span class="pre">permission</span></code> is one of <code class="docutils literal notranslate"><span class="pre">get</span></code>, <code class="docutils literal notranslate"><span class="pre">post</span></code>, <code class="docutils literal notranslate"><span class="pre">patch</span></code>, or <code class="docutils literal notranslate"><span class="pre">delete</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">target</span></code> is a <code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid_jsonapi.permission.PermissionTarget</span></code> object.
<code class="docutils literal notranslate"><span class="pre">target.type</span></code> will tell you whether the current authorisation request is for
a collection, item, or relationship and <code class="docutils literal notranslate"><span class="pre">target.name</span></code> will tell you the
collection or relationship name.</p>
<p><em>TODO</em> <code class="docutils literal notranslate"><span class="pre">mask</span></code> is a work in progress. When implemented it will specify which
attributes and relationships the permission filter should address. Any others
might not be represented in <code class="docutils literal notranslate"><span class="pre">object_rep</span></code> even though an object of that class
would usually have them. This is mainly to handle the case where the
request specifies a sparse field set.</p>
<p>Note that you can get the current sqlAlchemy session from
<code class="docutils literal notranslate"><span class="pre">view.dbsession</span></code> (which you might need to make the queries required
for authorisation) and the pyramid request from <code class="docutils literal notranslate"><span class="pre">view.request</span></code> which
should give you access to the usual things.</p>
<p>The simplest thing that a permission filter can do is return <code class="docutils literal notranslate"><span class="pre">True</span></code>
(<code class="docutils literal notranslate"><span class="pre">permission</span></code> is granted for the whole object) or <code class="docutils literal notranslate"><span class="pre">False</span></code>
(<code class="docutils literal notranslate"><span class="pre">permission</span></code> is denied for the whole object). To control permissions
for attributes or relationships, you must return a
<code class="xref py py-class docutils literal notranslate"><span class="pre">pyramid_jsonapi.permissions.Permission</span></code> object. You can create one
appropriate to the current view with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">permission_object</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">permission_object</span><span class="p">(</span>
  <span class="n">attributes</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">permission_template</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="c1"># Set of allowed attribute</span>
                                                  <span class="c1"># names. Defaults to all</span>
                                                  <span class="c1"># attributes.</span>
  <span class="n">relationships</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">permission_template</span><span class="o">.</span><span class="n">relationships</span><span class="p">,</span> <span class="c1"># Set of allowed rel</span>
                                                        <span class="c1"># names.</span>
  <span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="n">subtract_attributes</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>  <span class="c1"># Set of attributes to subtract.</span>
  <span class="n">subtract_relationships</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">()</span>  <span class="c1"># Set of relationships to subtract.</span>
<span class="p">)</span>
</pre></div>
</div>
<p>or you can construct one from scratch with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyramid_jsonapi.permissions</span> <span class="kn">import</span> <span class="n">Permission</span>
<span class="n">Permission</span><span class="p">(</span>
  <span class="n">template</span><span class="p">,</span> <span class="c1"># A template governing which attributes and relationships are</span>
            <span class="c1"># available. You should normally use view.permission_template.</span>
  <span class="n">attributes</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">attributes</span><span class="p">,</span> <span class="c1"># The set of allowed attribute names. The</span>
                                  <span class="c1"># default is all attributes in the template.</span>
  <span class="n">relationships</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">relationships</span><span class="p">,</span> <span class="c1"># The set of allowed rel names.</span>
  <span class="nb">id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Controls visibility of / action on the whole object.</span>
            <span class="c1"># Most of the time this should be True, which is the default.</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Permission objects are immutable.</p>
<p>The different target types are worth saying a little more about since they
affect how your permission filter is called.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target.type</span></code> <em>collection</em> means that the operation is against a collection
(almost certainly a GET or a POST). <code class="docutils literal notranslate"><span class="pre">target.name</span></code> will hold the name of the
collection. The <code class="docutils literal notranslate"><span class="pre">id</span></code> of <code class="docutils literal notranslate"><span class="pre">object_rep</span></code> might not be defined (it commonly
won’t be for POSTs). The handler calling the permission filter will not be
concerned with relationship authorisation and will ignore relationships
specified in any <code class="docutils literal notranslate"><span class="pre">Permission</span></code> object returned.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target.type</span></code> <em>item</em> means that the operation is against an item.
<code class="docutils literal notranslate"><span class="pre">target.name</span></code> will be empty (<code class="docutils literal notranslate"><span class="pre">None</span></code>). The <code class="docutils literal notranslate"><span class="pre">id</span></code> of <code class="docutils literal notranslate"><span class="pre">object_rep</span></code>
should reliably be present. The handler calling the permission filter will
not be concerned with relationship authorisation and will ignore
relationships specified in any <code class="docutils literal notranslate"><span class="pre">Permission</span></code> object returned.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target.type</span></code> <em>relationship</em> means that the operation is against a
relationship. <code class="docutils literal notranslate"><span class="pre">target.name</span></code> will hold the name of the relationship. The
<code class="docutils literal notranslate"><span class="pre">id</span></code> of <code class="docutils literal notranslate"><span class="pre">object_rep</span></code> should reliably be present. The permission filter
will be called once for each relationship to be authorised and for each
item in a to_many operation (once for each item posted to a to_many
operation, for example). The handler calling the permission filter will
<em>only</em> look at whether or not the relationship in question is in the
returned <code class="docutils literal notranslate"><span class="pre">Permission</span></code> object (it will be if you just return <code class="docutils literal notranslate"><span class="pre">True</span></code> and
won’t if you return <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p></li>
</ul>
</div></blockquote>
<p>Putting that together in some examples:</p>
<p>Let’s say you have banned the user ‘baddy’ and want to authorise GET requests so
that baddy can no longer fetch blogs. Both the <code class="docutils literal notranslate"><span class="pre">alter_document</span></code> and
<code class="docutils literal notranslate"><span class="pre">alter_result</span></code> stages would make sense as places to influence what will
be returned by a GET. We will choose <code class="docutils literal notranslate"><span class="pre">alter_result</span></code> here so that we are
authorising results as soon as
they come from the database. You might have something like this in
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">PyramidJSONAPI</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>
<span class="n">pj</span><span class="o">.</span><span class="n">view_classes</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Blogs</span><span class="p">]</span><span class="o">.</span><span class="n">register_permission_filter</span><span class="p">(</span>
  <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">],</span>
  <span class="p">[</span><span class="s1">&#39;alter_result&#39;</span><span class="p">],</span>
  <span class="k">lambda</span> <span class="n">obj</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span>  <span class="n">view</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_user</span> <span class="o">!=</span> <span class="s1">&#39;baddy&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Next, you want to do authorisation on PATCH requests and allow only the author
of a blog post to PATCH it. The <code class="docutils literal notranslate"><span class="pre">alter_request</span></code> stage is the most obvious
place to do this (you want to alter the request before it is turned into a
database update). You might do something like this in <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">PyramidJSONAPI</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">patch_posts_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">post_obj</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">db_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Posts</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="c1"># sqlalchemy 1.4+</span>
  <span class="c1"># post_obj = view.db_session.query(models.Posts).get(data[&#39;id&#39;]) # sqlalchemy &lt; 1.4</span>
  <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_user</span> <span class="o">==</span> <span class="n">post_obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span>
<span class="n">pj</span><span class="o">.</span><span class="n">view_classes</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Posts</span><span class="p">]</span><span class="o">.</span><span class="n">register_permission_filter</span><span class="p">(</span>
  <span class="p">[</span><span class="s1">&#39;patch&#39;</span><span class="p">],</span>
  <span class="p">[</span><span class="s1">&#39;alter_request&#39;</span><span class="p">],</span>
  <span class="n">patch_posts_filter</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Imagine that <code class="docutils literal notranslate"><span class="pre">Person</span></code> objects have an <code class="docutils literal notranslate"><span class="pre">age</span></code> attribute. Access to <code class="docutils literal notranslate"><span class="pre">age</span></code> is
sensitive so only the person themselves and anyone in the (externally defined)
<code class="docutils literal notranslate"><span class="pre">age_viewers</span></code> group should be able to see that attribute. Other viewers should
still be able to see the object so we can’t just return <code class="docutils literal notranslate"><span class="pre">False</span></code> from the
permission filter - we must use the fuller return format.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pj</span> <span class="o">=</span> <span class="n">pyramid_jsonapi</span><span class="o">.</span><span class="n">PyramidJSONAPI</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_person_filter</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="c1"># This could be done in one &#39;if&#39; but we split it out here for clarity.</span>
  <span class="c1">#</span>
  <span class="c1"># A person should see the full object for themselves.</span>
  <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_user</span> <span class="o">==</span> <span class="n">person</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="c1">#</span>
  <span class="c1"># Anyone in the age_viewers group should also see the full object.</span>
  <span class="c1"># get_group_members() is an imagined function in this app which gets the</span>
  <span class="c1"># members of a named group.</span>
  <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_user</span> <span class="ow">in</span> <span class="n">get_group_members</span><span class="p">(</span><span class="s1">&#39;age_viewers&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="c1"># Everyone else isn&#39;t allowed to see age.</span>
  <span class="k">return</span> <span class="n">Permission</span><span class="o">.</span><span class="n">subtractive</span><span class="p">(</span>
    <span class="c1"># subtractive constructs an object by subtracting sets.</span>
    <span class="n">view</span><span class="o">.</span><span class="n">permission_template</span><span class="p">,</span>
    <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">}</span>  <span class="c1"># &#39;age&#39; will be removed from the set of attributes.</span>
  <span class="p">)</span>

<span class="n">pj</span><span class="o">.</span><span class="n">view_classes</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Person</span><span class="p">]</span><span class="o">.</span><span class="n">register_permission_filter</span><span class="p">(</span>
  <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">],</span>
  <span class="p">[</span><span class="s1">&#39;alter_result&#39;</span><span class="p">],</span>
  <span class="n">get_person_filter</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="what-happens-with-authorisation-failures">
<h3>What Happens With Authorisation Failures<a class="headerlink" href="#what-happens-with-authorisation-failures" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="metadata.html" class="btn btn-neutral float-right" title="Metadata Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="client.html" class="btn btn-neutral float-left" title="Consuming the API from the Client End" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016, Colin Higgs.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>